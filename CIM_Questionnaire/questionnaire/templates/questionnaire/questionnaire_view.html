{% extends "questionnaire/questionnaire_base.html" %}


{% load questionnaire_filters %}
{% load mptt_tags %}


{% block scripts %}

    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}questionnaire/js/ext/jquery.dynatree.min.js"></script>
    <!-- TODO: ENCOUNTERED BUG IN jquery.formset.min.js [http://code.google.com/p/django-dynamic-formset/issues/detail?id=54] -->
    <!-- MODIFIED LOCAL CODE TO FIX THIS; SHOULD SEND PATCH -->
    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}questionnaire/js/ext/jquery.formset.js"></script>
    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}questionnaire/js/questionnaire_edit.js"></script>
    <script language="javascript">

    {# no need for an if-block here; users can only view existing realizations #}
    var get_form_section_view = "get_existing_edit_form_section/{{ root_model_id }}";

    /* just setup a minimum of jquery-ui functionality */
    $(document).ready(
        function() {

            var parent = document.body;

            /* do this first so that the dialogs appear near the top of the page */
            init_dialogs(parent);

            /* do this next, so it can happen while other widgets are loading */
            render_msg($("#msg"));

            /* disable all editing in the "view" form */

            /* I do this by "overloading" the show_pane fn; */
            /* after a pane is loaded, I then make all properties read-only */
            /* (got the syntax from: http://stackoverflow.com/a/9134757) */

            /* (do this before any init_widget fns have the chance to call the old show_pane) */

            /* ...hiding the add/remove/replace/etc buttons is done via CSS below */

            show_pane = (function() {
                var cached_show_pane = show_pane;
                return function(pane_key) {
                    var pane = $("#" + pane_key + "_pane");
                    cached_show_pane.apply(this, arguments);
                    setTimeout(function(){
                        var standard_properties = $(pane).find("tr.field");
                        var standard_properties_atomic = $(standard_properties).find("input, textarea, select");
                        var standard_properties_enumeration = $(standard_properties).find("div.multiselect");
                        var scientific_properties = $(pane).find("div.scientific_property");
                        var scientific_properties_atomic = $(scientific_properties).find("input, textarea");
                        var scientific_properties_enumeration = $(scientific_properties).find("div.multiselect");
                        var all_properties =
                                $(standard_properties_atomic)
                                .add(standard_properties_enumeration)
                                .add(scientific_properties_atomic)
                                .add(scientific_properties_enumeration);

                        $(all_properties).each(function() {
                            $(this).addClass("ui-state-disabled");  /* addClass("readonly") */
                            $(this).focus(function() {
                                this.blur();
                            })
                        });

                    }, 2000);
                    /* I am not happy w/ this "setTimeout" hack */
                    /* but I don't know a better way to deal w/ the fact that */
                    /* the original "show_pane" uses asynchronous AJAX */
                }
            }());

            init_widgets(users,$(parent).find("#user"));
            init_widgets(helps,$(parent).find(".help_button"));
            init_widgets(buttons,$(parent).find("input.button"))
            init_widgets(panes,$(parent).find(".pane"));
            init_widgets(treeviews,$(parent).find(".treeview"));

            {% if not vocabularies %}
                {% get_default_vocabulary_key as root_vocabulary_key %}
                {% get_default_component_key as root_component_key %}
                show_pane("{{ root_vocabulary_key }}_{{ root_component_key }}");
            {% endif %}

            /* do this last b/c some of the xpath depends on changes made by the above fns... */
            init_errors(parent);

        }
    );

    </script>

{% endblock %} {# /scripts #}


{% block style %}

    <link rel='stylesheet' type="text/css" href="{{ STATIC_URL }}questionnaire/css/ext/jquery.dynatree.css"/>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}questionnaire/css/questionnaire_edit.css" />

    <style type="text/css">
        #questionniare .no_float { float: none !important; }
        /* hide all the interactive features in the view */
        #questionnaire button.add, button.remove, button.replace, button.reset, button.ui-datepicker-trigger { display: none !important; }
        #questionnaire div.inheritance_options { display: none !important; background: none !important; }
        #questionnaire div.inheritance_options * { display: none !important; background: none !important; }
    </style>

{% endblock %} {# / style #}


{% block title %}
    CIM Questionnaire Viewer
{% endblock %} {# /title #}


{% block content %}

    {% block content_title %}
        <div class="title">
            Viewing {{ model_customizer.model_title|a_or_an }} <b>{{model_customizer.model_title|title}}</b> instance for the <a href="/{{ project.name|lower }}" title="ES-DOC Questionnaire Project Home"><b>{{project.title|title}}</b></a> Project
        </div> <!-- /.title -->
    {% endblock %} {# /content_title #}


    {% block content_documentation %}
        <div class="documentation">

            <p>
                Use this form to view a {{ model_customizer.model_title|title }} document in the CIM Questionnaire.
                This is a <em>read-only</em> form used only for <em>viewing</em> a document.
                If you wish to create or edit a document, you must use the editor form.
                This may require registering for a CIM Questionnaire account as well as joining the {{project.title|title}} Project.
            </p>
            <p>
                <a href="/edit/help" target="blank"><strong>More detailed instructions</strong></a> are available.
            </p>

            {%  if model_customizer.model_description %}
                <p style="border: 1px solid #B9E0E3; padding: 8px;">
                    {{model_customizer.model_description|safe}}
                </p>
            {% endif %}
        </div> <!-- /.documentation -->
    {% endblock %} {# /content_documentation #}


    <form method="POST" action="">

        {% csrf_token %}

        <!-- some useful stuff for AJAX calls -->
        <input class="hidden" type="text" id="_version_key" name="version_key" value="{{ version.key }}"/>
        <input class="hidden" type="text" id="_project_name" name="project_name" value="{{ project.name|lower }}"/>
        <input class="hidden" type="text" id="_document_type" name="document_type" value="{{ model_proxy.name|lower }}"/>
        <input class="hidden" type="text" id="_instance_key" name="instance_key" value="{{ instance_key }}"/>

        <div class="form"> {# wrap everything in div.form, so I can group related fields together #}

            <fieldset>

                <!-- section for toggling incompletion icons -->
                <div id="completion">
                    <div class="help_button" title="click for more info" id="completion_toggle">
                        <span class="default-help-icon ui-icon-info" style="display: inline-block;">&nbsp;</span>
                        <div class="help_description" title="view completion status">
                            Use this checkbox to toggle the indication of incomplete sections.
                            When selected, any section with required properties that have <em>not</em> been filled in will be indicated by this icon:
                            <!-- inline styling here b/c this will show up outside the containing #questionnaire <div> -->
                            <span class="ui-state-error-text"><span class="ui-icon ui-icon-pin-w" style="display: inline-block; vertical-align: middle;">&nbsp;</span></span>
                            Only documents with no incomplete properties can be published.
                        </div> <!-- /.help_description -->
                    </div> <!-- /.help_button -->
                    <label for="completion_toggle">view completion status:</label>
                    <input type="checkbox" id="completion_toggle" onclick="toggle_completion_icons(this.checked);"/>
                </div> <!-- /#completion -->

                {% get_default_vocabulary_key as root_vocabulary_key %}
                {% get_default_component_key as root_component_key %}

                {% if vocabularies %}
                    <!-- naughty, naughty developer using tables -->
                    <table border="0" width="100%">
                        <tr valign="top">
                            <td width="15%">
                                <div id="component_tree">
                                    <div id="component_tree_header">
                                        <div class="help_button" title="click for more info" id="component_hierarchy_help">
                                            <span class="default-help-icon ui-icon-info" style="display: inline-block;">&nbsp;</span>
                                            <div class="help_description" title="{{model_customizer.model_hierarchy_name}}">
                                                This section allows users to traverse the full component hierarchy of a document.  Use the checkboxes to indicate that component is to be included as part of the current document.
                                            </div> <!-- /.help_description -->
                                        </div> <!-- /.help_button -->
                                        {{model_customizer.model_hierarchy_name}}
                                    </div>
                                    <div id="component_tree_content">
                                        <div class="treeview">
					    {% if model_customizer.model_show_hierarchy %}
                                            <ul><!-- style="display: none;">-->
                                                <li data="key:'{{root_vocabulary_key}}_{{root_component_key}}'">
                                                    {{model_customizer.model_root_component}}
					    {% endif %} {# /model_customizer.model_show_hierarchy #}
                                                    <ul>
                                                    {% for vocabulary in vocabularies %}
                                                        {% with nodes=vocabulary.component_proxies.all vocabulary_key=vocabulary.get_key %}
                                                            {# look at how cool mppt is! #}
                                                            {# this is all that's needed to re-create the component hierarchy! #}
                                                            {# wow!! #}
                                                            {% recursetree nodes %}
                                                                <li data="key:'{{vocabulary_key}}_{{node.get_key}}'">  {# node is a component; it has a key #}
                                                                    <span> {{ node.name }}  {# {% include "questionnaire/_completion.html" %} #}  </span>
                                                                    {% if not node.is_leaf_node %}
                                                                        <ul>
                                                                            {{ children }}
                                                                        </ul>
                                                                    {% endif %} {# / not node.is_leaf_node #}
                                                                </li>
                                                            {% endrecursetree %}
                                                        {% endwith %} {# / nodes #}
                                                    {% endfor %} {# / vocabulary #}
                                                    </ul>
                                                {% if model_customizer.model_show_hierarchy %}
                                                </li>
                                            </ul>
                                            {% endif %} {# /model_customizer.model_show_hierarchy #}
                                        </div> <!-- /.treeview -->
                                    </div> <!-- /#component_tree_content -->
                                </div> <!-- /#component_tree -->
                            </td>
                            <td width="85%">
                {% endif %} {# /vocabularies #}

                {# doing this here, outside of the formset loop, b/c standard categories & properties are the same for every component #}
                {# this therefore avoids multiple queries of the db #}
                {% with active_standard_categories_and_properties=model_customizer.get_active_standard_categories_and_properties %}

                    {{ model_formset.management_form }}
                    {{ model_formset.non_form_errors }}

                    {% for model_form in model_formset %}

                        <div class="pane" id="{{ model_form.prefix }}_pane" data-section-key="{{ version.key }}|{{ model_proxy.name|lower }}|{{ model_form.get_vocabulary_key }}|{{ model_form.get_component_key }}">
                            <div class="documentation unloaded">This pane has not yet been loaded.</div>
                        </div> <!-- /.pane -->

                    {%  endfor %}

                {% endwith %} {# active_standard_categories_and_properties #}

                {% if vocabularies %}
                            </td>
                        </tr>
                    </table>
                {% endif %} {# /vocabularies #}

            </fieldset>


            {% block content_submit %}
                <!-- there is no ability to submit from the "view" template -->
            {% endblock %} {# /content_submit #}


        </div> <!-- /.form -->
    </form>

{% endblock %} {# /content #}


{% block footer %}
    This form is generated by the <a target="_blank" href="https://github.com/ES-DOC/esdoc-questionnaire">CIM Questionnaire</a> (v{{questionnaire_version}}).
    <br/>It uses the CIM Version "{% if version.url %}<a target="_blank" href="{{version.url}}">{% endif %}{{ version }}{% if version.url %}</a> {% endif %}".
    {% if vocabularies %}
    &nbsp;And it includes the Controlled Vocabularies
    {% for vocabulary in vocabularies %}
        {% if not forloop.first %}, {% endif %}
            "<a target="_blank" href="{{vocabulary.file.url}}">{{vocabulary}}</a>"{% endfor %}. {# /vocabulary #}
    {% endif %}
    <br/>For more information please contact: <a href="mailto:es-doc-support@list.woc.noaa.gov">es-doc-support@list.woc.noaa.gov</a>.<br/>
{% endblock %} {# /footer #}
