{% extends "questionnaire/api/_section.html" %}

{% load questionnaire_filters %}

{% block content %}

    {% with section_parameters.version as version %}
    {% with section_parameters.model_proxy as model_proxy %}
    {% with section_parameters.vocabulary as vocabulary %}
    {% with section_parameters.component as component %}
    {% with section_parameters.formset as formset %}
    {% with section_parameters.categories_formset as categories_formset %}

        {% with vocabulary_key=vocabulary.get_key %}
            {% with component_key=component.get_key %}

                <div id="tab_scientific_properties_{{ vocabulary_key }}_{{ component_key }}" data-section-key="{{ version.key }}|{{ model_proxy.name.lower }}|{{ vocabulary_key }}|{{ component_key }}">
                    <div class="tab_content"> <!-- inner tab content -->

                        {% with formset=categories_formset %}
                            {% include "questionnaire/_categories.html" %}
                        {% endwith %}

                        {{ formset.management_form }}
                        {# formset.non_form_errors #}

                        {% if formset.number_of_properties %}

                            <span class="subform_toolbar ui-widget-header ui-corner-all">
                                <button type="button" class="sort">sort</button>
                                <ul class="sort_by">
                                    <li><a href="#" name="sort_by_name">by name</a></li>
                                    <li><a href="#" name="sort_by_category">by category</a></li>
                                    <li><a href="#" name="sort_by_order" title="(category order + property order)">by order</a></li>
                                </ul>
                                <button type="button" class="expand" title="expand all properties">expand all</button>
                                <button type="button" class="collapse" title="collapse all properties">collapse all</button>
                            </span> <!-- /.subform_toolbar -->
                            <div style="clear: both;">&nbsp;</div>

                        {% endif %} {# formset.number_of_properties #}

                        <div class="accordion" prefix="{{formset.prefix}}">
                            {% for form in formset %}

                                <h3 class="accordion_header">
                                    <table border="0" width="90%">
                                        <tr valign="center">
                                            {% for field in form.get_header_fields %}
                                                <td>
                                                    <b>{{field.label}}:&nbsp;</b>{{ field }}
                                                </td>
                                            {% endfor %} {# /field in form.get_header_fields #}
                                        </tr>
                                    </table>
                                </h3> <!-- /.accordion_header -->

                                <div class="accordion_content">
                                    <div class="form"> {# wrapping everything in a div.form so I can group together fields belonging to the same model #}

                                        <div class="hidden">
                                            {# the fields I explicitly set to hidden #}
                                            {% for field in form.get_hidden_fields %}
                                                {{ field }}
                                            {% endfor %} {# /field #}
                                            {# and the fields that are hidden by default #}
                                            {% for hidden_field in form.hidden_fields %}
                                                {{ hidden_field }}
                                            {% endfor %} {# /hidden_field #}
                                            {# and a special form-only (ie: not part of the underlying model) field #}
                                            {# which helps w/ the load-on-demand paradigm #}
                                            {{ form.loaded }}
                                        </div>

                                        <table width="100%">
                                            {% for field in form.get_fields %}
                                                <tr class="{% cycle 'odd' 'even' %} field" name="{{field.html_name}}" valign="top">
                                                    {% include "questionnaire/_field.html" %}
                                                </tr>
                                            {% endfor %} {# / field in form.get_fields #}

                                            <tr>
                                                <td colspan="100">
                                                    <fieldset class="collapsible_fieldset extra_attributes">
                                                        <legend title="click to toggle content">
                                                            <span class="title">&nbsp;Extra Attributes&nbsp;</span>
                                                        </legend>
                                                        <div class="collapsible_fieldset_content">
                                                            <div class="documentation">
                                                                <p>
                                                                    Every scientific property can have additional information associated with it.
                                                                </p>
                                                            </div> <!-- /.documentation -->
                                                            <table width="100%" class="extra_attributes">
                                                                <tr>
                                                                    <th>Extra Attribute</th>
                                                                    <th>Display</th>
                                                                    <th>Allow Editing</th>
                                                                    <th>Default Value(s)</th>
                                                                </tr>
                                                                {% for label,fields in form.get_extra_fieldsets.items %}
                                                                    <tr class="{% cycle 'even' 'odd' %} field">
                                                                        <td>
                                                                            {{label}}
                                                                        </td>
                                                                        {% for field in fields %}
                                                                            <td>
                                                                                {{field}}
                                                                                {% if field.errors %}
                                                                                    {% include "questionnaire/_error.html" %}
                                                                                {% endif %} {# / field.errors #}
                                                                            </td>
                                                                        {% endfor %}
                                                                    </tr>
                                                                {% endfor %} {# / field in form.get_extra_fieldsets #}
                                                            </table>
                                                        </div><!-- /.collapsible_fielset_content -->
                                                    </fieldset>
                                                </td>
                                            </tr>
                                        </table>

                                    </div> <!-- /.form -->
                                </div> <!-- /.accordion_content -->

                            {% endfor %} {# /form #}
                        </div> <!-- /.accordion -->

                    </div> <!-- /.tab_content -->
                </div> <!-- /#tab_scientific_properties_{{ vocabulary_key }}_{{ component_key }} -->

            {% endwith %} {# /component_key #}
        {% endwith %} {# /vocabulary_key #}

    {% endwith %} {# /catgories_formset #}
    {% endwith %} {# /formset #}
    {% endwith %} {# /component #}
    {% endwith %} {# /vocabulary #}
    {% endwith %} {# /model_proxy #}
    {% endwith %} {# /version #}

{% endblock %} {# /content #}