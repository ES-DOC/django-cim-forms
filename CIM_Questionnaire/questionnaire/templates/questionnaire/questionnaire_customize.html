{% extends "questionnaire/questionnaire_base.html" %}

{% load questionnaire_filters %}
{% load mptt_tags %}

{% block scripts %}

    <!-- ext js -->
    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}questionnaire/js/ext/jquery.tagit.min.js"></script>
    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}questionnaire/js/ext/jquery.formset.js"></script>

    <!--custom js -->
    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}questionnaire/js/questionnaire_customize.js"></script>

    <script language="javascript">

    /* this is passed by the view */
    /* it is the name of the AJAX fn to use when loading a form section */
    var get_section_view_name = "{{ get_section_view_name }}";

    function show_vocabulary_content(vocabulary_key) {

        var vocabulary_section = $("div#" + vocabulary_key);

        if (!$(vocabulary_section).hasClass("loaded")) {

            toastr.info("loading...");

            var project_name = $("#_project_name").val();
            var instance_key = $("#_instance_key").val();
            var section_key = $(vocabulary_section).attr("data-section-key");

            /* get_form_section_view is the name of the AJAX view to return the particular type of form (new vs existing, edit vs customize) */
            /* for this template; it is set in the template header */
            var url = window.document.location.protocol + "//" + window.document.location.host + "/api/" + project_name + "/" + get_section_view_name + "/" + section_key;
            url += "?instance_key=" + instance_key;
            $.ajax({
                url: url,
                type: "GET",
                success: function (data) {

                    $(vocabulary_section).html(data);
                    $(vocabulary_section).ready(function () {

                        var parent = $(vocabulary_section);
                        init_widgets(tabs, $(parent).find(".tabs"));
                        init_widgets(tags, $(parent).find(".tags"));
                        init_widgets(buttons, $(parent).find("input.button"))
                        init_widgets(accordions, $(parent).find(".accordion").not(".fake"));
                        init_widgets(sortable_accordions, $(parent).find(".accordion .accordion_header"));
                        init_widgets(accordion_buttons, $(parent).find(".subform_toolbar button"));
                        init_widgets(fieldsets,$(parent).find(".collapsible_fieldset"));
                        init_widgets(readonlies,$(parent).find(".readonly"));
                        init_widgets(enablers, $(parent).find(".enabler"));
                        init_widgets(multiselects, $(parent).find(".multiselect"));
                        init_widgets(helps, $(parent).find(".help_button"));

                        /* initialize the load-on-demand stuff */
                        /* (JQuery has some clever events bound to the tab widget, */
                        /* but they only apply in the case of content loaded by AJAX, */
                        /* so I initialize this stuff on the "show" event of the tab_content) */
                        var vocabulary_tabs = $(parent).find("div.vocabulary_tabs");
                        var vocabulary_tabs_content = $(vocabulary_tabs).find("div.tab_content");
                        $(vocabulary_tabs_content).on("show", function() {
                            var tab_id = $(this).parent("div.ui-tabs-panel").attr("id");
                            show_vocabulary_content(tab_id);
                        });
                        /* be sure to load the 1st one by default */
                        /* (a quirk of JQuery means the show event does not fire for content that "starts" already shown) */
                        $(vocabulary_tabs_content).first().trigger("show");

                        /* identify the section as loaded for js... */
                        $(vocabulary_section).addClass("loaded");
                        /* and for the django view... */
                        $(vocabulary_section).find("input[name$='-loaded']").prop('checked', true);

                    });

                    toastr.clear();
                }
            });
        }
    }


    /* just setup a minimum of jquery-ui functionality */

    $(document).ready(
        function() {

            var parent = document.body;

            // do this first so that the dialogs appear near the top of the page
            init_dialogs(parent);

            // do this next, so it can happen while other widgets are loading
            render_msg($("#msg"));

            init_widgets(fieldsets,$(parent).find(".collapsible_fieldset"));
            init_widgets_on_show(readonlies,$(parent).find(".readonly"));

            init_widgets(enablers, $(parent).find(".enabler"));
            init_widgets(accordions, $(parent).find(".accordion").not(".fake"));
            init_widgets(sortable_accordions, $(parent).find(".accordion .accordion_header"));
            init_widgets(accordion_buttons, $(parent).find(".subform_toolbar button"));
            init_widgets(tags, $(parent).find(".tags"));
            init_widgets(tabs, $(parent).find(".tabs"));
            init_widgets(users, $(parent).find("#user"));
            init_widgets(buttons, $(parent).find("input.button,a.button"))
            init_widgets(multiselects, $(parent).find(".multiselect"));
            init_widgets(helps, $(parent).find(".help_button"));

            /*  some one-offs for the customizer */
            $("button.customize_subform").button({
                  icons : {primary: "ui-icon-extlink"},
                  text : true
            });

            /* TODO: MOVE THIS STUFF TO SEPARATE FNS */

            var model_customizer_vocabularies = $("div#vocabularies");
            var vocabularies_tabs = $("div#vocabularies_tabs");
            var vocabularies_tabs_headers = $(vocabularies_tabs).find("ul:first li");

            $(model_customizer_vocabularies).find("input.active").each(function() {

                var model_customizer_vocabulary = $(this).closest("div.model_customizer_vocabulary");
                var vocabulary_key = $(model_customizer_vocabulary).find("input.key").val();
                var vocabulary_tab = $(vocabularies_tabs_headers).has("a[href^='#tab_scientific_properties_"+vocabulary_key+"']");
                var vocabulary_index = $(vocabularies_tabs_headers).index(vocabulary_tab);
                var vocabulary_tab_content = $(vocabularies_tabs).children("div.ui-tabs-panel").eq(vocabulary_index);

                if ($(this).is(":checked")) {
                    $(model_customizer_vocabulary).addClass("selected");
                    $(vocabularies_tabs).tabs("enable", vocabulary_index);
                    $(vocabulary_tab_content).removeClass("ui-state-disabled");
                }
                else {
                    $(model_customizer_vocabulary).addClass("ui-state-disabled");
                    $(vocabularies_tabs).tabs("disable", vocabulary_index);
                    $(vocabulary_tab_content).addClass("ui-state-disabled");
                }

                $(this).change(function() {
                    $(model_customizer_vocabulary).toggleClass("ui-state-disabled")
                    $(model_customizer_vocabulary).toggleClass("selected");
                    if ($(model_customizer_vocabulary).hasClass("selected")) {
                        $(vocabularies_tabs).tabs("enable", vocabulary_index);
                        $(vocabulary_tab_content).removeClass("ui-state-disabled");
                    }
                    else {
                        $(vocabularies_tabs).tabs("disable", vocabulary_index);
                        $(vocabulary_tab_content).addClass("ui-state-disabled");
                    }
                });
            });

            $(model_customizer_vocabularies).sortable({
                axis: "y",
                items: "div.model_customizer_vocabulary",
                placeholder: "sortable_item",
                cancel : "input.active",
                start : function(e, ui){
                    ui.placeholder.height(ui.item.height());
                },
                stop : function(e,ui) {
                    var sortable_item = ui["item"];
                    $(sortable_item).closest("#vocabularies").find("div.model_customizer_vocabulary").each(function(index, element) {
                        var vocabulary_order = $(this).find("input.order");
                        $(vocabulary_order).val(index+1)
                    });
                }
            });

            /* initialize the load-on-demand stuff */
            /* (JQuery has some clever events bound to the tab widget, */
            /* but they only apply in the case of content loaded by AJAX, */
            /* so I initialize this stuff on the "show" event of the tab_content) */
            $(vocabularies_tabs).find("div.tab_content").on("show", function() {
                var tab_id = $(this).parent("div.ui-tabs-panel").attr("id");
                show_vocabulary_content(tab_id);
            });

            // do this last b/c some of the xpath depends on changes made by the above fns...
            init_errors(parent);

        }

    );

    </script>
{% endblock %} {# /scripts #}

{% block style %}

    <!-- ext css -->
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}questionnaire/css/ext/jquery.tagit.css" />

    <!-- custom css -->
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}questionnaire/css/questionnaire_customize.css" />

    <style type="text/css">
        #questionniare .no_float    { float: none !important; }

        #questionnaire #vocabularies { display: inline-block; }
        #questionnaire #vocabularies div.model_customizer_vocabulary { cursor: pointer; padding: 2px; margin: 0px; }
        #questionnaire #vocabularies .vocabulary { }
        #questionnaire #vocabularies .active { width: 50px; }
        #questionnaire #vocabularies .order { width: 100px; text-align: right; }

        #questionnaire table.extra_attributes th { text-decoration: underline; text-align: left; }

    </style>

{% endblock %} {# / style #}

{% block title %}
    CIM Questionnaire Customizer
{% endblock %} {# /title #}

{% block content %}

    <div class="hidden_dialog" id="customize_subform_dialog"     title="customize">&nbsp;</div>

    {% block content_title %}
        <div class="title">
            Customize the CIM Questionnaire for <b>{{model_proxy.name|pretty_string}}</b> instances of the <a href="/{{ project.name|lower }}" title="ES-DOC Questionnaire Project Home"><b>{{project.title}}</b></a> Project
        </div> <!-- /.title -->
    {% endblock %} {# /content_title #}


    <div class="documentation">
        <p>
            Use this form to customize how a particular CIM Document for a particular Questionnaire Project is presented.
            Drag-and-drop properties, and categories to specify an order.
            Specify customizable features for each property.
            When you have finished, click the "submit" button at the bottom of the page.
            Invalid entries are indicated using a <span style="color: #ff0000; font-weight: bold;">red</span> font.
            <a href="/customize/help" target="blank"><b>More detailed instructions</b></a> are available.
        </p>
    </div> <!-- /.documentation -->

    <form method="POST" action="">

        {% csrf_token %}

        <!-- some useful stuff for AJAX calls -->
        <input class="hidden" type="text" id="_version_key" name="version_key" value="{{ version.key }}"/>
        <input class="hidden" type="text" id="_project_name" name="project_name" value="{{ project.name|lower }}"/>
        <input class="hidden" type="text" id="_document_type" name="document_type" value="{{ model_proxy.name|lower }}"/>
{#        <input class="hidden" type="text" id="_session_id" name="session_id" value="{{ session_id }}"/>#}
        <input class="hidden" type="text" id="_instance_key" name="instance_key" value="{{ instance_key }}"/>

        <div class="form"> {# wrap everything in div.form, so I can group related fields together #}

            <div class="hidden">
                {% for field in model_customizer_form.get_hidden_fields %} 
                    {{field}}                                              
                {% endfor %}                                               
            </div> <!-- /.hidden -->

            <fieldset class="collapsible_fieldset">
                <legend title="click to toggle content">
                    <span class="title">&nbsp;Customization Details&nbsp;</span>
                </legend>

                <div class="collapsible_fieldset_content">
                    <div class="documentation">
                        <p>
                            This section contains information relating to the <i>customization</i> itself, as opposed to the form being customized.
                        </p>
                    </div> <!-- /.documentation -->

                    <table width="100%">
                        {% for field in model_customizer_form.get_customizer_fields %}
                            <tr class="{% cycle 'odd' 'even' %} field" name="{{field.html_name}}">
                                {% include "questionnaire/_field.html" %}
                            </tr>
                        {% endfor %} {# / field in model_customizer_form.get_customizer_fields #}
                        <tr class="odd field" name="sorted_vocabularies">
                            <td>
                                <span>{{ model_customizer_vocabularies_formset.label }}&nbsp;</span>
                                <div class="documentation">
                                    {{ model_customizer_vocabularies_formset.help_text|safe }}  {# the safe filter prevents inline HTML from being escaped  #}
                                </div>
                            </td>
                            <td>
                                {{ model_customizer_vocabularies_formset.management_form }}
                                <div id="vocabularies" class="sortable ui-widget ui-widget-content ui-corner-all">
                                    {% if vocabularies.count %}
                                        <div class="ui-widget ui-content ui-corner-all ui-state-default" style="text-align: center;">
                                            <span class="active" style="float: left;">&nbsp;active&nbsp;</span>
                                            name
                                            <span class="order" style="float: right;">&nbsp;order&nbsp;</span>
                                        </div>
                                        {% for model_customizer_vocabulary_form in model_customizer_vocabularies_formset %}
                                            <div class="model_customizer_vocabulary ui-widget ui-widget-content ui-corner-all ui-state-default">
                                                {{ model_customizer_vocabulary_form.id }} <!-- this is a hidden field; it still needs inclusion in order to validate -->
                                                {{ model_customizer_vocabulary_form.vocabulary_key }} <!-- this is also hidden field; it's needed to match the vocabulary_tabs below -->
                                                {{ model_customizer_vocabulary_form.active }}&nbsp;
                                                {{ model_customizer_vocabulary_form.vocabulary }}&nbsp;
                                                {{ model_customizer_vocabulary_form.order }}&nbsp;
                                            </div>
                                        {% endfor %} {# /model_customizer_vocabulary_form #}
                                    {% else %}
                                        <span class="documentation">There are no CVs associated with this document type &amp; project.</span>
                                    {% endif %} {# vocabularies.count #}
                                </div>
                            </td>
                        </tr>
                    </table>

                </div> <!-- / .collapsible_fieldset_content -->

            </fieldset> <!-- / .collapsible_fieldset -->

            <fieldset class="collapsible_fieldset">
                <legend title="click to toggle content">
                    <span class="title">&nbsp;Document Details&nbsp;</span>
                </legend>

                <div class="collapsible_fieldset_content">
                    <div class="documentation">
                        <p>
                            This section contains information relating to the <i>document</i> itself.  This will appear in the title of the document form.
                        </p>
                    </div> <!-- /.documentation -->

                    <table width="100%">
                        {% for field in model_customizer_form.get_document_fields %}
                            <tr class="{% cycle 'odd' 'even' %} field" name="{{field.html_name}}">
                                {% include "questionnaire/_field.html" %}
                            </tr>
                        {% endfor %} {# / field in model_customizer_form.get_document_fields #}
                    </table>

                </div> <!-- / .collapsible_fieldset_content -->

            </fieldset> <!-- / .collapsible_fieldset -->

            <fieldset class="collapsible_fieldset">
                <legend title="click to toggle content">
                    <span class="title">&nbsp;Property Details&nbsp;</span>
                </legend>

                <div class="collapsible_fieldset_content">
                    <div class="documentation">
                        <p>
                            This section contains information relating to the properties of the document. This includes both those defined by the metadata version (ie: the standard CIM content) as well as those defined by the controlled vocabularies (ie: the scientific properties).
                        </p>
                    </div> <!-- /.documentation -->

                    <div class="tabs">
                        <ul> <!-- the tab menu -->
                            <li>
                                <a href="#tab_standard_properties">
                                    Standard Properties (CIM)
                                </a>
                            </li>
                            <li>
                                <a href="#tab_scientific_properties">
                                    Scientific Properties (CV)
                                </a>
                            </li>
                        </ul>

                        <div id="tab_standard_properties">
                            <div class="tab_content">
                                <div class="form">
                                    <div class="documentation">
                                        <p>
                                            These properties are defined by the CIM Schema.
                                        </p>
                                    </div> <!-- /.documentation -->

                                    {% with formset=standard_category_customizer_formset %}
                                        {% include "questionnaire/_categories.html" %}
                                    {% endwith %}

                                    <!-- this section is pretty similar to the "_formset.html" template -->
                                    <!-- but those are intended for the editing form -->
                                    <!-- the titles, etc. of the accordions are different for the customization form -->
                                    {% with formset=standard_property_customizer_formset %}

                                        {{ formset.management_form }}
                                        {# formset.non_form_errors #}

                                        {% if formset.forms %}

                                            <span class="subform_toolbar ui-widget-header ui-corner-all">
                                                <button type="button" class="sort">sort</button>
                                                <ul class="sort_by">
                                                    <li><a href="#" name="sort_by_name">by name</a></li>
                                                    <li><a href="#" name="sort_by_category">by category</a></li>
                                                    <li><a href="#" name="sort_by_field_type">by field type</a></li>
                                                    <li><a href="#" name="sort_by_order" title="(category order + property order)">by order</a></li>
                                                </ul>
                                                <button type="button" class="expand" title="expand all properties">expand all</button>
                                                <button type="button" class="collapse" title="collapse all properties">collapse all</button>
                                            </span> <!-- /.subform_toolbar -->
                                            <div style="clear: both;">&nbsp;</div>

                                        {% endif %} {# / formset.forms #}

                                        <div class="accordion" prefix="{{formset.prefix}}">
                                            {% for form in formset %}
                                                <h3 class="accordion_header">
                                                    <table width="90%" border="0">
                                                        <tr valign="center">
                                                            {% for field in form.get_header_fields %}
                                                                <td>
                                                                    <b>{{field.label}}:&nbsp;</b>{{ field }}
                                                                </td>
                                                            {% endfor %} {# / field in form.get_header_fields #}
                                                        </tr>
                                                    </table>
                                                </h3> <!-- /.accordion_header -->

                                                <div class="accordion_content">

                                                    <div class="form"> {# wrapping everything in a div.form so I can group together fields belonging to the same model #}

                                                        <div class="hidden">
                                                            {# the fields I explicitly set to hidden #}
                                                            {% for field in form.get_hidden_fields %}
                                                                {{ field }}
                                                            {% endfor %} {# /field #}
                                                            {# and the fields that are hidden by default #}
                                                            {% for hidden_field in form.hidden_fields %}
                                                                {{ hidden_field }}
                                                            {% endfor %} {# /hidden_field #}
                                                            {# and a special form-only (ie: not part of the underlying model) field #}
                                                            {# which helps w/ the load-on-demand paradigm #}
                                                            {{ form.loaded }}
                                                        </div>

                                                        <table width="100%">
                                                            {% with type=form.type %}
                                                                {% if type == "ATOMIC" %}
                                                                    {% for field in form.get_atomic_fields %}
                                                                        <tr class="{% cycle 'odd' 'even' %} field" name="{{field.html_name}}" valign="top">
                                                                            {% include "questionnaire/_field.html" %}
                                                                        </tr>
                                                                    {% endfor %} {# / field in form.get_atomic_fields #}
                                                                {% elif type == "ENUMERATION" %}
                                                                    {% for field in form.get_enumeration_fields %}
                                                                        <tr class="{% cycle 'odd' 'even' %} field" name="{{field.html_name}}" valign="top">
                                                                            {% include "questionnaire/_field.html" %}
                                                                        </tr>
                                                                    {% endfor %} {# / field in form.get_enumeration_fields #}
                                                                {% elif type == "RELATIONSHIP" %}
                                                                    {% for field in form.get_relationship_fields %}
                                                                        <tr class="{% cycle 'odd' 'even' %} field" name="{{field.html_name}}" valign="top">
                                                                            {% if field.name|lower == "relationship_show_subform" %}
                                                                                {# this is a copy of the "_field" template, but it adds a 'customize_subform' button to the field #}
                                                                                {% with field_label=field.label field_id=field.html_name %}
                                                                                    <td>
                                                                                        {% if field.help_text %}
                                                                                            {% include "questionnaire/_help.html" %}
                                                                                        {% endif %} {# /field.help_text #}
                                                                                        <span>{{field_label}}&nbsp;</span>
                                                                                    </td>
                                                                                    <td>
                                                                                        {{field}}
                                                                                        <span class="documentation">
                                                                                            Before customizing a subform, be sure to save the current customization.
                                                                                        </span>
                                                                                        <br/>
                                                                                        <button type="button"
                                                                                                class="customize_subform"
                                                                                                name="customize_subform"
                                                                                                title="Customize the subform corresponding to this field."
                                                                                                onClick="customize_property_subform({{ form|get_instance_pk }}, '{{ form.prefix }}-subform_customizer');"
                                                                                        >
                                                                                            customize subform
                                                                                        </button>
                                                                                        {% if field.errors %}
                                                                                            {% include "questionnaire/_error.html" %}
                                                                                        {% endif %} {# / field.errors #}
                                                                                    </td>
                                                                                {% endwith %}

                                                                            {% else %}
                                                                                {% include "questionnaire/_field.html" %}
                                                                            {% endif %}
                                                                        </tr>
                                                                    {% endfor %} {# / field in form.get_relationship_fields #}
                                                                {% endif %}
                                                            {% endwith %}
                                                        </table>

                                                    </div> <!-- /.form -->

                                                </div> <!-- /.accordion_content -->

                                            {% endfor %}
                                        </div> <!-- /.accordion -->
                                    {% endwith %} {# /formset #}
                                </div> <!-- /.form -->
                            </div> <!-- /.tab_content -->
                        </div> <!-- /#tab_standard_properties -->

                        <div id="tab_scientific_properties">
                            <div class="tab_content">

                                <div class="documentation">
                                    <p>
                                        These properties are defined by the CVs.
                                    </p>
                                </div> <!-- /.documentation -->

                                <div class="tabs" id="vocabularies_tabs">
                                    <ul>
                                        {% for vocabulary in vocabularies %}
                                            {% with vocabulary_key=vocabulary.get_key %}
                                                <li>
                                                    <a href="#tab_scientific_properties_{{ vocabulary_key }}">
                                                        {{ vocabulary }}
                                                    </a>
                                                </li>
                                            {% endwith %} {# /vocabulary_key #}
                                        {% endfor %} {# /vocabulary #}
                                    </ul>

                                    {% for vocabulary in vocabularies %}
                                        {% with vocabulary_key=vocabulary.get_key %}

                                            <div id="tab_scientific_properties_{{ vocabulary_key }}" data-section-key="{{ version.key }}|{{ model_proxy.name.lower }}|{{ vocabulary_key }}">
                                                <div class="tab_content">
                                                    <div class="unloaded">
                                                        This section has not yet been loaded.
                                                    </div>
                                                </div>
                                            </div> <!-- /#tab_scientific_properties_{{ vocabulary_key }} -->

                                        {% endwith %} {# /vocabulary_key #}
                                    {% endfor %} {# /vocabulary #}

                                </div> <! --/.tabs -->

                            </div> <!-- /.tab_content -->
                        </div> <!-- /#tab_scientific_properties -->


            </fieldset> <!-- / .collapsible_fieldset -->

            <div class="submit">
                <input class="button" name="_save" type="submit" value="save"/>
                {% if can_view %}
                    {% with project_name=project.name|lower version_key=version.get_key|lower model_name=model_proxy.name|lower %}
                        {% url 'questionnaire.views.edit_new' project_name version_key model_name  as url_edit_new %}
                        <a class="button" target="_blank" href="{{ url_edit_new }}" title="view a blank {{ model_proxy.name }} document in the Editor using this customization">view in Editor</a>
                    {% endwith %}
                {% endif %} {# /can_view #}
            </div> <!-- /.submit -->
            <div style="clear: both;">&nbsp;</div>

        </div> <!-- /.form -->
    </form>

{% endblock %} {# /content #}

{% block footer %}
    This form is generated by the <a target="_blank" href="https://github.com/ES-DOC/esdoc-questionnaire">CIM Questionnaire</a> (v{{questionnaire_version}}).
    <br/>It uses the CIM Version "{% if version.url %}<a target="_blank" href="{{version.url}}">{% endif %}{{ version }}{% if version.url %}</a> {% endif %}".
    {% if vocabularies %}
    &nbsp;And it includes the Controlled Vocabularies
    {% for vocabulary in vocabularies %}
        {% if not forloop.first %}, {% endif %}
            "<a target="_blank" href="{{vocabulary.file.url}}">{{vocabulary}}</a>"{% endfor %}. {# /vocabulary #}
    {% endif %}
    <br/>For more information please contact: <a href="mailto:es-doc-support@list.woc.noaa.gov">es-doc-support@list.woc.noaa.gov</a>.<br/>
{% endblock %} {# /footer #}

